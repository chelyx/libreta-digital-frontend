<div class="main-content">
  <div class="content-wrapper">
    <h2 class="title">Historial de Asistencia</h2>
    <p class="subtitle">Registro completo de Asistencias</p>

    <!-- ================================
              BUSCADORES
    =================================-->
    <div class="search-section">
      <div class="search-option">
        <div class="option-header">
          <span class="step-number">1</span>
          <label class="label">Seleccionar Curso</label>
        </div>
        <select
          class="select-input"
          [(ngModel)]="cursoSeleccionado"
          (change)="onCursoChange()"
        >
          <option value="" disabled selected>Seleccione un curso</option>
          <option *ngFor="let curso of cursos" [value]="curso.id">
            {{ curso.nombre }} - {{ curso.codigo }}
          </option>
        </select>
        <p class="help-text">Elige un curso de la lista disponible</p>
      </div>

      <div class="divider">
        <span class="divider-text">o</span>
      </div>

      <div class="search-option">
        <div class="option-header">
          <span class="step-number">2</span>
          <label class="label">Buscar por C칩digo de Curso</label>
        </div>

        <div class="search-input-wrapper">
          <svg
            class="search-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>

          <input
            type="text"
            class="search-input"
            placeholder="Ingresa el C칩digo del curso (ej: K101)"
            [(ngModel)]="cursoIdBusqueda"
            (input)="onBuscarPorId()"
          />
        </div>

        <p class="help-text">
          Introduce el c칩digo 칰nico del curso para b칰squeda r치pida
        </p>
      </div>

      <button
        class="search-button"
        (click)="buscarCurso()"
        [disabled]="!cursoSeleccionado && !cursoIdBusqueda"
      >
        <svg
          class="button-icon"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        Buscar Curso
      </button>
    </div>

    <div class="info-note">
      <svg
        class="info-icon"
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
      <p>
        Podes buscar el curso seleccion치ndolo de la lista o ingresando directamente su
        c칩digo.
      </p>
    </div>

    <!-- ================================
              TABLA AGRUPADA
    =================================-->
    <div class="content-block" *ngIf="cursoSeleccionado || cursoIdBusqueda">
      <h3 class="section-title">Asistencias del curso</h3>
      <p class="section-subtitle">
        Visualiza y gestiona el registro de asistencias por alumno
      </p>

      <div class="loading" *ngIf="cargando">
        <svg class="spinner" viewBox="0 0 50 50">
          <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>
        <span>Cargando asistencias...</span>
      </div>

      <div class="error" *ngIf="!cargando && errorMsg">
        {{ errorMsg }}
      </div>

      <div
        class="table-wrapper"
        *ngIf="!cargando && !errorMsg && asistencias.length"
      >
        <table class="asist-table">
          <thead>
          <tr>
            <th>Alumno</th>
            <th>Presente</th>
            <th class="acciones-column">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <!-- 游댮 UNA SOLA FILA POR ALUMNO -->
          <tr *ngFor="let grupo of asistenciasPorAlumno">
            <!-- Columna alumno -->
            <td class="alumno-cell">
              <span class="alumno-nombre">{{ grupo.nombre }}</span>
            </td>

            <!-- Columna presente: todas las fechas de ese alumno -->
            <td>
              <div class="historial-fechas">
                <div
                  class="historial-item"
                  *ngFor="let a of grupo.registros"
                >
                  <span class="historial-fecha">{{ a.fecha }}</span>

                  <ng-container *ngIf="!estaEditando(a); else edicionPresente">
                      <span
                        class="pill"
                        [class.ok]="a.presente"
                        [class.no]="!a.presente"
                      >
                        {{ a.presente ? 'S칤' : 'No' }}
                      </span>
                  </ng-container>

                  <ng-template #edicionPresente>
                    <div class="edit-buttons">
                      <button
                        class="toggle-button"
                        [class.active]="a.presente"
                        (click)="cambiarPresente(a, true)"
                      >
                        S칤
                      </button>
                      <button
                        class="toggle-button"
                        [class.active]="!a.presente"
                        (click)="cambiarPresente(a, false)"
                      >
                        No
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>

            <!-- Columna acciones: un lapicito (y guardar/cancelar) por fecha -->
            <td class="acciones-column">
              <div class="historial-fechas">
                <div
                  class="historial-item"
                  *ngFor="let a of grupo.registros"
                >
                  <ng-container *ngIf="!estaEditando(a); else edicionAcciones">
                    <button
                      mat-icon-button
                      class="edit-button"
                      (click)="editarAsistencia(a)"
                      matTooltip="Editar asistencia"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                  </ng-container>

                  <ng-template #edicionAcciones>
                    <div class="action-buttons">
                      <button
                        mat-icon-button
                        class="save-button"
                        (click)="guardarAsistencia(a)"
                        matTooltip="Guardar"
                      >
                        <mat-icon>check</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        class="cancel-button"
                        (click)="cancelarEdicion(a)"
                        matTooltip="Cancelar"
                      >
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div
        class="empty"
        *ngIf="!cargando && !errorMsg && (!asistencias || asistencias.length === 0)"
      >
        No hay asistencias para mostrar.
      </div>
    </div>
  </div>
</div>
