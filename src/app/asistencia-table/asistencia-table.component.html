<div class="main-content">
  <div class="content-wrapper">
    <h2 class="title">Historial de Asistencia</h2>
    <app-buscador-curso [cursos]="cursos" (selected)="onCursoChange($event)" >

    </app-buscador-curso>

    <!-- ================================
              TABLA AGRUPADA
    =================================-->
    <div class="content-block" *ngIf="cursoSeleccionado">
      <h3 class="section-title">Asistencias de {{cursoSeleccionado.nombre}} - {{cursoSeleccionado.codigo}}</h3>
      <p class="section-subtitle">
        Visualiza y gestiona el registro de asistencias por alumno
      </p>

      <div class="loading" *ngIf="cargando">
        <svg class="spinner" viewBox="0 0 50 50">
          <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>
        <span>Cargando asistencias...</span>
      </div>

      <div class="error" *ngIf="!cargando && errorMsg">
        {{ errorMsg }}
      </div>

      <div
        class="table-wrapper"
        *ngIf="!cargando && !errorMsg && asistencias.length"
      >
        <table class="asist-table">
          <thead>
          <tr>
            <th>Alumno</th>
            <th>Presente</th>
            <th class="acciones-column">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <!-- ðŸ”´ UNA SOLA FILA POR ALUMNO -->
          <tr *ngFor="let grupo of asistenciasPorAlumno">
            <!-- Columna alumno -->
            <td class="alumno-cell">
              <span class="alumno-nombre">{{ grupo.nombre }}</span>
            </td>

            <!-- Columna presente: todas las fechas de ese alumno -->
            <td>
              <div class="historial-fechas">
                <div
                  class="historial-item"
                  *ngFor="let a of grupo.registros"
                >
                  <span class="historial-fecha">{{ a.fecha }}</span>

                  <ng-container *ngIf="!estaEditando(a); else edicionPresente">
                      <span
                        class="pill"
                        [class.ok]="a.presente"
                        [class.no]="!a.presente"
                      >
                        {{ a.presente ? 'SÃ­' : 'No' }}
                      </span>
                  </ng-container>

                  <ng-template #edicionPresente>
                    <div class="edit-buttons">
                      <button
                        class="toggle-button"
                        [class.active]="a.presente"
                        (click)="cambiarPresente(a, true)"
                      >
                        SÃ­
                      </button>
                      <button
                        class="toggle-button"
                        [class.active]="!a.presente"
                        (click)="cambiarPresente(a, false)"
                      >
                        No
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>

            <!-- Columna acciones: un lapicito (y guardar/cancelar) por fecha -->
            <td class="acciones-column">
              <div class="historial-fechas">
                <div
                  class="historial-item"
                  *ngFor="let a of grupo.registros"
                >
                  <ng-container *ngIf="!estaEditando(a); else edicionAcciones">
                    <button
                      mat-icon-button
                      class="edit-button"
                      (click)="editarAsistencia(a)"
                      matTooltip="Editar asistencia"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                  </ng-container>

                  <ng-template #edicionAcciones>
                    <div class="action-buttons">
                      <button
                        mat-icon-button
                        class="save-button"
                        (click)="guardarAsistencia(a)"
                        matTooltip="Guardar"
                      >
                        <mat-icon>check</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        class="cancel-button"
                        (click)="cancelarEdicion(a)"
                        matTooltip="Cancelar"
                      >
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div
        class="empty"
        *ngIf="!cargando && !errorMsg && (!asistencias || asistencias.length === 0)"
      >
        No hay asistencias para mostrar.
      </div>
    </div>
  </div>
</div>
